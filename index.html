<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>V√≥ley Tracker - Tracking Manual</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0; padding: 20px;
      background: #f0f0f0;
    }
    #container {
      position: relative;
      width: 960px;
      height: 540px;
      margin: auto;
      border: 2px solid #333;
      background: black;
    }
    #video {
      position: absolute;
      top: 0; left: 0;
      width: 960px;
      height: 540px;
      z-index: 1;
    }
    #overlay {
      position: absolute;
      top: 0; left: 0;
      width: 960px;
      height: 540px;
      z-index: 10;
      cursor: crosshair;
    }
    button, select, input {
      margin: 5px;
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #output {
      margin-top: 15px;
      font-family: monospace;
      white-space: pre-wrap;
      background: #eee;
      padding: 10px;
      width: 960px;
      margin: auto;
      border-radius: 4px;
      min-height: 60px;
      text-align: left;
      color: #222;
    }
    #controls {
      width: 960px;
      margin: 0 auto 20px auto;
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>

<h2>üèê V√≥ley Tracker - Tracking Manual</h2>

<div id="controls">
  <label for="mode">Modo:</label>
  <select id="mode">
    <option value="file">üìÇ Video Grabado</option>
    <option value="live">üé• C√°mara en Vivo</option>
  </select>

  <input type="file" accept="video/*" id="videoInput" />
  <button id="startCamera" style="display:none;">Iniciar C√°mara</button>
</div>

<div id="container">
  <video id="video" controls muted></video>
  <canvas id="overlay"></canvas>
</div>

<div id="controls">
  <button id="marcarReferencia">üìè Marcar referencia (2 clics)</button>
  <button id="iniciarMarcacion" disabled>üñ±Ô∏è Iniciar marcaci√≥n manual</button>
  <button id="finalizarMarcacion" disabled>üèÅ Finalizar marcaci√≥n</button>
</div>

<div id="controls">
  <button id="togglePlay">‚ñ∂Ô∏è Play / Pausa</button>
  <button id="stepBack">‚è™ -1 frame</button>
  <button id="stepForward">‚è© +1 frame</button>
  <button id="resetBtn">üîÅ Reset</button>
</div>

<div id="output">üìå Carg√° un video o activ√° la c√°mara. Luego marc√° la referencia para escalar.</div>

<script>
(() => {
  const video = document.getElementById("video");
  const overlay = document.getElementById("overlay");
  const ctx = overlay.getContext("2d");
  const output = document.getElementById("output");

  const togglePlay = document.getElementById("togglePlay");
  const resetBtn = document.getElementById("resetBtn");
  const stepBack = document.getElementById("stepBack");
  const stepForward = document.getElementById("stepForward");

  const videoInput = document.getElementById("videoInput");
  const startCamera = document.getElementById("startCamera");
  const mode = document.getElementById("mode");

  const marcarBtn = document.getElementById("marcarReferencia");
  const iniciarMarcacionBtn = document.getElementById("iniciarMarcacion");
  const finalizarMarcacionBtn = document.getElementById("finalizarMarcacion");

  const WIDTH = 960;
  const HEIGHT = 540;

  overlay.width = WIDTH;
  overlay.height = HEIGHT;

  let clicks = [];
  let escala = null;
  let esperandoClics = false;

  let marcacionActiva = false;
  let posiciones = []; // {x, y, tiempo}

  // Limpiar canvas
  function clearCanvas() {
    ctx.clearRect(0, 0, WIDTH, HEIGHT);
  }

  // Dibuja punto
  function drawPoint(x, y, color = "red") {
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(x, y, 6, 0, 2 * Math.PI);
    ctx.fill();
  }

  // Dibuja l√≠nea
  function drawLine(p1, p2, color = "green") {
    ctx.strokeStyle = color;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(p1.x, p1.y);
    ctx.lineTo(p2.x, p2.y);
    ctx.stroke();
  }

  // Dibuja trayectoria
  function drawTrayectoria() {
    if (posiciones.length < 2) return;
    ctx.strokeStyle = "blue";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(posiciones[0].x, posiciones[0].y);
    for (let i = 1; i < posiciones.length; i++) {
      ctx.lineTo(posiciones[i].x, posiciones[i].y);
    }
    ctx.stroke();
  }

  // Actualiza dibujo en canvas: video + referencias + trayectoria + √∫ltimo punto marcado
  function actualizarCanvas() {
    clearCanvas();
    ctx.drawImage(video, 0, 0, WIDTH, HEIGHT);

    // Dibuja referencia (2 puntos y l√≠nea)
    if (clicks.length >= 1) drawPoint(clicks[0].x, clicks[0].y, "green");
    if (clicks.length >= 2) {
      drawPoint(clicks[1].x, clicks[1].y, "green");
      drawLine(clicks[0], clicks[1], "green");
    }

    // Dibuja trayectoria marcada
    drawTrayectoria();

    // Dibuja √∫ltimo punto marcado
    if (posiciones.length > 0) {
      const ultimo = posiciones[posiciones.length - 1];
      drawPoint(ultimo.x, ultimo.y, "red");
    }
  }

  // Mensaje y datos en output
  function mostrarDatos() {
    if (posiciones.length < 2) {
      output.textContent = "Marc√° posiciones en cada cuadro para trackear.";
      return;
    }
    let texto = "Posiciones marcadas:\n";
    let totalDistancia = 0;
    for (let i = 1; i < posiciones.length; i++) {
      const a = posiciones[i-1];
      const b = posiciones[i];
      const dx = b.x - a.x;
      const dy = b.y - a.y;
      const distPx = Math.sqrt(dx*dx + dy*dy);
      const distM = distPx * escala;
      totalDistancia += distM;
      const dt = b.t - a.t;
      const vel = dt > 0 ? (distM / dt) * 3.6 : 0; // km/h
      texto += `#${i}: t=${b.t.toFixed(2)}s, x=${b.x.toFixed(0)}, y=${b.y.toFixed(0)}, d=${distM.toFixed(2)}m, v=${vel.toFixed(2)}km/h\n`;
    }
    texto += `\nDistancia total recorrida: ${totalDistancia.toFixed(2)} metros`;
    output.textContent = texto;
  }

  // Eventos

  marcarBtn.addEventListener("click", () => {
    clicks = [];
    escala = null;
    esperandoClics = true;
    marcacionActiva = false;
    posiciones = [];
    iniciarMarcacionBtn.disabled = true;
    finalizarMarcacionBtn.disabled = true;
    clearCanvas();
    output.textContent = "üéØ Hac√© 2 clics sobre los extremos visibles de la red (9 metros)";
  });

  overlay.addEventListener("click", (e) => {
    const rect = overlay.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    if (esperandoClics) {
      if (clicks.length < 2) {
        clicks.push({x, y});
        actualizarCanvas();
        if (clicks.length === 2) {
          // calcular escala
          const dx = clicks[1].x - clicks[0].x;
          const dy = clicks[1].y - clicks[0].y;
          const distPx = Math.sqrt(dx*dx + dy*dy);
          escala = 9 / distPx;
          output.textContent = `‚úÖ Referencia marcada. Escala: 1 px = ${escala.toFixed(4)} metros. Ahora inici√° la marcaci√≥n manual.`;
          esperandoClics = false;
          iniciarMarcacionBtn.disabled = false;
        }
      }
    } else if (marcacionActiva) {
      // Agregar posici√≥n manual para frame actual
      const t = video.currentTime;
      posiciones.push({x, y, t});
      actualizarCanvas();
      mostrarDatos();
    }
  });

  iniciarMarcacionBtn.addEventListener("click", () => {
    if (!escala) {
      alert("Primero marc√° la referencia (red)");
      return;
    }
    marcacionActiva = true;
    iniciarMarcacionBtn.disabled = true;
    finalizarMarcacionBtn.disabled = false;
    output.textContent = "üñ±Ô∏è Marcaci√≥n manual activa. Hac√© clic para marcar posici√≥n en cada cuadro.";
    video.pause();
  });

  finalizarMarcacionBtn.addEventListener("click", () => {
    marcacionActiva = false;
    iniciarMarcacionBtn.disabled = false;
    finalizarMarcacionBtn.disabled = true;
    output.textContent += "\nüèÅ Marcaci√≥n finalizada.";
  });

  togglePlay.addEventListener("click", () => {
    if (video.paused) {
      video.play();
      output.textContent = "‚ñ∂Ô∏è Reproduciendo video. Paus√° para marcar.";
    } else {
      video.pause();
      output.textContent = "‚è∏Ô∏è Video pausado. Pod√©s marcar posici√≥n si la marcaci√≥n est√° activa.";
    }
  });

  stepBack.addEventListener("click", () => {
    video.pause();
    video.currentTime = Math.max(0, video.currentTime - 1/30);
    actualizarCanvas();
  });

  stepForward.addEventListener("click", () => {
    video.pause();
    video.currentTime = Math.min(video.duration, video.currentTime + 1/30);
    actualizarCanvas();
  });

  resetBtn.addEventListener("click", () => {
    clicks = [];
    escala = null;
    esperandoClics = false;
    marcacionActiva = false;
    posiciones = [];
    iniciarMarcacionBtn.disabled = true;
    finalizarMarcacionBtn.disabled = true;
    clearCanvas();
    video.pause();
    video.currentTime = 0;
    output.textContent = "üìå Carg√° un video o activ√° c√°mara y marc√° referencia para empezar.";
  });

  videoInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      stopCamera();
      video.srcObject = null;
      video.src = URL.createObjectURL(file);
      video.load();
      video.pause();
      output.textContent = "üìå Video cargado. Paus√° el video y marc√° la referencia.";
      resetBtn.disabled = false;
      iniciarMarcacionBtn.disabled = true;
      finalizarMarcacionBtn.disabled = true;
    }
  });

  startCamera.addEventListener("click", async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({video:true});
      video.srcObject = stream;
      video.play();
      output.textContent = "üé• C√°mara activa. Paus√° para marcar referencia y posiciones.";
      resetBtn.disabled = false;
      iniciarMarcacionBtn.disabled = true;
      finalizarMarcacionBtn.disabled = true;
    } catch (err) {
      alert("No se pudo iniciar la c√°mara: " + err.message);
    }
  });

  function stopCamera() {
    if(video.srcObject) {
      video.srcObject.getTracks().forEach(track => track.stop());
      video.srcObject = null;
    }
  }

  mode.addEventListener("change", () => {
    if(mode.value === "file"){
      videoInput.style.display = "inline";
      startCamera.style.display = "none";
      stopCamera();
      video.pause();
      video.removeAttribute("src");
      video.load();
      output.textContent = "üìå Seleccion√° un video para analizar.";
      resetBtn.disabled = true;
      iniciarMarcacionBtn.disabled = true;
      finalizarMarcacionBtn.disabled = true;
    } else {
      videoInput.style.display = "none";
      startCamera.style.display = "inline";
      output.textContent = "üé• Activ√° la c√°mara para empezar.";
      resetBtn.disabled = true;
      iniciarMarcacionBtn.disabled = true;
      finalizarMarcacionBtn.disabled = true;
    }
  });

  mode.dispatchEvent(new Event('change'));

  // Dibuja constantemente la imagen + marcaciones cuando el video est√° pausado para que se vea
  video.addEventListener("pause", actualizarCanvas);
  video.addEventListener("seeked", actualizarCanvas);
})();
</script>

</body>
</html>
