<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>V√≥ley Tracker - Tracking Autom√°tico B√°sico</title>
<style>
  body { font-family: Arial, sans-serif; text-align:center; padding: 20px; }
  #container { position: relative; display: inline-block; }
  video, canvas { max-width: 100%; border: 2px solid #333; }
  #overlay { position: absolute; top: 0; left: 0; pointer-events:none; }
  #output { margin-top: 20px; font-size: 18px; }
  button, select { margin: 5px; padding: 5px 10px; }
  #historial { margin-top: 20px; max-width: 600px; margin-left: auto; margin-right: auto; text-align:left; }
</style>
</head>
<body>

<h2>üèê V√≥ley Tracker - Tracking Autom√°tico B√°sico</h2>

<label>Modo de video:</label>
<select id="mode">
  <option value="file">Video Grabado</option>
  <option value="live">C√°mara en Vivo</option>
</select><br>

<input type="file" accept="video/*" id="videoInput" /><br>
<button id="startCamera" style="display:none;">Activar C√°mara</button><br><br>

<div id="container">
  <video id="video" controls autoplay muted></video>
  <canvas id="overlay"></canvas>
</div>

<div>
  <button id="togglePlay">‚ñ∂Ô∏è Play</button>
  <button id="resetBtn">Reset</button>
</div>

<div id="output">üìå Carg√° un video y pausalo. Luego hac√© dos clics sobre los extremos de la red (9 m).</div>

<div id="historial">
  <h3>Historial de Mediciones</h3>
  <ul id="listaHistorial"></ul>
</div>

<script>
const video = document.getElementById('video');
const videoInput = document.getElementById('videoInput');
const startCamera = document.getElementById('startCamera');
const modeSelector = document.getElementById('mode');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const output = document.getElementById('output');
const togglePlay = document.getElementById('togglePlay');
const resetBtn = document.getElementById('resetBtn');
const listaHistorial = document.getElementById('listaHistorial');

let stream = null;
let escala = null;
let clicks = [];
let state = 'marcarRed';
let historial = [];

let previousFrame = null;
let trackingData = [];
let trackingActive = false;

function initCanvas() {
  overlay.width = video.videoWidth;
  overlay.height = video.videoHeight;
}
video.addEventListener('loadedmetadata', () => {
  initCanvas();
});

function clearCanvas() {
  ctx.clearRect(0, 0, overlay.width, overlay.height);
}

function drawPoint(x,y,color='red') {
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.arc(x,y,5,0,2*Math.PI);
  ctx.fill();
}

function drawLine(p1,p2,color='green') {
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(p1.x,p1.y);
  ctx.lineTo(p2.x,p2.y);
  ctx.stroke();
}

function drawBox(x,y,w,h,color='red') {
  ctx.strokeStyle = color;
  ctx.lineWidth = 3;
  ctx.strokeRect(x,y,w,h);
}

overlay.addEventListener('click', (e) => {
  if(state !== 'marcarRed') return; // Solo para definir la red
  
  const rect = video.getBoundingClientRect();
  const scaleX = video.videoWidth / rect.width;
  const scaleY = video.videoHeight / rect.height;
  const x = (e.clientX - rect.left) * scaleX;
  const y = (e.clientY - rect.top) * scaleY;

  clicks.push({x,y});
  drawPoint(x,y,'green');

  if(clicks.length === 2){
    drawLine(clicks[0], clicks[1], 'green');
    const dx = clicks[1].x - clicks[0].x;
    const dy = clicks[1].y - clicks[0].y;
    const distPix = Math.sqrt(dx*dx + dy*dy);
    escala = 9 / distPix;
    output.innerHTML = `‚úÖ Escala definida: 1 px = ${escala.toFixed(4)} m<br>Presion√° ‚ñ∂Ô∏è Play para iniciar tracking autom√°tico.`;
    state = 'tracking';
  }
});

function differenceFrames(frame1, frame2, width, height) {
  let maxDiff = 0;
  let maxX = 0, maxY = 0;

  for(let y=0; y < height; y+=4) {
    for(let x=0; x < width; x+=4) {
      const i = (y * width + x) * 4;
      const diff = Math.abs(frame1.data[i] - frame2.data[i]) + 
                   Math.abs(frame1.data[i+1] - frame2.data[i+1]) + 
                   Math.abs(frame1.data[i+2] - frame2.data[i+2]);
      if(diff > maxDiff) {
        maxDiff = diff;
        maxX = x;
        maxY = y;
      }
    }
  }
  return {maxDiff, maxX, maxY};
}

function processFrame() {
  if(video.paused || video.ended || !trackingActive) return;

  ctx.drawImage(video, 0, 0, overlay.width, overlay.height);
  const frame = ctx.getImageData(0, 0, overlay.width, overlay.height);

  if(previousFrame){
    const {maxDiff, maxX, maxY} = differenceFrames(previousFrame, frame, overlay.width, overlay.height);

    // Definir caja alrededor
    const boxSize = 40;
    let boxX = Math.max(0, maxX - boxSize/2);
    let boxY = Math.max(0, maxY - boxSize/2);
    if(boxX + boxSize > overlay.width) boxX = overlay.width - boxSize;
    if(boxY + boxSize > overlay.height) boxY = overlay.height - boxSize;

    drawBox(boxX, boxY, boxSize, boxSize, 'red');

    // Guardar posici√≥n centro
    const centerX = boxX + boxSize/2;
    const centerY = boxY + boxSize/2;

    trackingData.push({time: video.currentTime, x: centerX, y: centerY});

    if(trackingData.length >= 2){
      // Calcular distancia y velocidad entre √∫ltimos dos puntos
      const p1 = trackingData[trackingData.length-2];
      const p2 = trackingData[trackingData.length-1];
      const dx = p2.x - p1.x;
      const dy = p2.y - p1.y;
      const distPix = Math.sqrt(dx*dx + dy*dy);
      const metros = distPix * escala;
      const dt = p2.time - p1.time;
      if(dt > 0){
        const velocidad = (metros / dt) * 3.6;
        output.innerHTML = `üöÄ Velocidad actual estimada: <strong>${velocidad.toFixed(2)} km/h</strong><br>
          Tiempo: ${p2.time.toFixed(2)} s<br>
          Distancia entre frames: ${metros.toFixed(2)} m`;
      }
    }
  }
  previousFrame = frame;

  requestAnimationFrame(processFrame);
}

togglePlay.addEventListener('click', () => {
  if(video.paused){
    video.play();
    togglePlay.innerText = '‚è∏Ô∏è Pausa';
    if(state === 'tracking') {
      trackingActive = true;
      processFrame();
    }
  } else {
    video.pause();
    togglePlay.innerText = '‚ñ∂Ô∏è Play';
    trackingActive = false;
  }
});

resetBtn.addEventListener('click', () => {
  clicks = [];
  escala = null;
  previousFrame = null;
  trackingData = [];
  trackingActive = false;
  state = 'marcarRed';
  clearCanvas();
  output.innerHTML = "üìå Carg√° un video y pausalo. Luego hac√© dos clics sobre los extremos de la red (9 m).";
});

modeSelector.addEventListener('change', () => {
  if(modeSelector.value === 'file'){
    videoInput.style.display = 'inline';
    startCamera.style.display = 'none';
    stopCamera();
  } else {
    videoInput.style.display = 'none';
    startCamera.style.display = 'inline';
  }
});

videoInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if(file){
    stopCamera();
    video.srcObject = null;
    video.src = URL.createObjectURL(file);
  }
});

startCamera.addEventListener('click', async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject = stream;
  } catch(e) {
    alert('No se pudo acceder a la c√°mara: ' + e.message);
  }
});

function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
}

function clearCanvas() {
  ctx.clearRect(0, 0, overlay.width, overlay.height);
}
</script>

</body>
</html>



